{% extends "base.html" %} {% block title %}Mowing Area - Autonomous Mower{%
endblock %} {% block head_extra %}
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=drawing,geometry"></script>
<style>
  /* Custom styles for Google Maps */
  .map-container {
    height: 600px;
    width: 100%;
    border-radius: var(--border-radius);
  }
  .home-marker {
    color: var(--primary);
    font-size: 24px;
  }
</style>
{% endblock %} {% block content %}
<div class="dashboard-header">
  <h1>Mowing Area Configuration</h1>
  <div class="d-flex align-center">
    <span class="status-indicator" id="areaConnectionStatus"></span>
    <span id="areaStatusText" class="mr-2">Connected</span>
  </div>
</div>

<div class="card mb-3">
  <div class="card-header">
    <h3>Map View</h3>
    <div class="card-header-actions">
      <button id="toggle-satellite" class="btn btn-sm btn-secondary">
        <i class="fas fa-satellite"></i> Toggle Satellite
      </button>
    </div>
  </div>
  <div class="card-body">
    <div id="map" class="map-container"></div>
    <div class="map-instructions mt-2">
      <p>
        <i class="fas fa-info-circle"></i> Use the drawing tools to define your
        mowing area. Click points to create a polygon.
      </p>
    </div>
  </div>
</div>

<div class="map-controls">
  <div class="card mb-3">
    <div class="card-header">
      <h3>Configuration Controls</h3>
    </div>
    <div class="card-body">
      <div class="control-buttons mb-3">
        <button
          id="confirm-area-button"
          class="btn btn-success btn-lg control-btn"
          disabled
        >
          <i class="fas fa-check-circle"></i> Confirm Mowing Area
        </button>
        <button
          id="confirm-home-button"
          class="btn btn-primary btn-lg control-btn"
          disabled
        >
          <i class="fas fa-home"></i> Set Home Location
        </button>
      </div>
      <div class="control-buttons">
        <button id="reset-area-button" class="btn btn-danger control-btn">
          <i class="fas fa-trash"></i> Reset Area
        </button>
        <button id="check-polygon-button" class="btn btn-secondary control-btn">
          <i class="fas fa-search"></i> View Coordinates
        </button>
      </div>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-header">
      <h3>Camera Feed</h3>
      <div class="card-header-actions">
        <button id="toggleCameraBtn" class="btn btn-sm btn-secondary">
          <i class="fas fa-video"></i> Toggle Camera
        </button>
      </div>
    </div>
    <div class="card-body">
      <div class="camera-container">
        <img
          id="video_feed"
          src="{{ url_for('video_feed') }}"
          alt="Camera Feed"
          class="camera-feed"
        />
        <div class="camera-overlay" id="cameraOverlay">
          <div class="camera-status">Camera Loading...</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="card mt-3" id="coordinatesCard" style="display: none">
  <div class="card-header">
    <h3>Area Coordinates</h3>
    <div class="card-header-actions">
      <button id="close-coordinates" class="btn btn-sm btn-secondary">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </div>
  <div class="card-body">
    <pre id="coordinates-display" class="coordinates-display"></pre>
    <button id="copy-coordinates" class="btn btn-secondary mt-2">
      <i class="fas fa-copy"></i> Copy to Clipboard
    </button>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  let map;
  let drawControl;
  let drawnItems;
  let homeMarker;
  let isPolygonComplete = false;
  let isSatelliteView = false;

  // Initialize map when DOM is loaded
  document.addEventListener("DOMContentLoaded", function () {
    initMap();
    initControls();
    updateAreaConnectionStatus();
    initCameraControls();
  });

  function initMap() {
    // Default center (will be updated with GPS)
    const defaultCenter = { lat: 0, lng: 0 };

    // Initialize the map
    map = new google.maps.Map(document.getElementById("map"), {
      zoom: 18,
      center: defaultCenter,
      mapTypeId: google.maps.MapTypeId.ROADMAP,
      mapTypeControl: false,
      streetViewControl: false,
      fullscreenControl: true,
    });

    // Initialize the drawing manager
    drawControl = new google.maps.drawing.DrawingManager({
      drawingMode: null,
      drawingControl: true,
      drawingControlOptions: {
        position: google.maps.ControlPosition.TOP_CENTER,
        drawingModes: [google.maps.drawing.OverlayType.POLYGON],
      },
      polygonOptions: {
        fillColor: "#8BC34A",
        fillOpacity: 0.5,
        strokeWeight: 3,
        strokeColor: "#689F38",
        clickable: true,
        editable: true,
        zIndex: 1,
      },
    });
    drawControl.setMap(map);

    // Initialize array to store drawn polygons
    drawnItems = [];

    // Get current position from GPS and center map
    sendCommand("get_position", {}, function (response) {
      if (
        response.success &&
        response.data.latitude &&
        response.data.longitude
      ) {
        const position = {
          lat: response.data.latitude,
          lng: response.data.longitude,
        };
        map.setCenter(position);
      } else {
        showAlert(
          "Unable to get current position. Using default view.",
          "warning"
        );
      }
    });

    // Load existing polygon if available
    loadExistingArea();

    // Handle polygon complete event
    google.maps.event.addListener(
      drawControl,
      "polygoncomplete",
      function (polygon) {
        // Clear any existing polygons
        clearPolygons();

        // Add the new polygon to our array
        drawnItems.push(polygon);

        // Enable the confirm button
        isPolygonComplete = true;
        document.getElementById("confirm-area-button").disabled = false;

        // Set drawing mode to null (hand tool)
        drawControl.setDrawingMode(null);
      }
    );

    // Toggle satellite/street view
    document
      .getElementById("toggle-satellite")
      .addEventListener("click", function () {
        if (isSatelliteView) {
          map.setMapTypeId(google.maps.MapTypeId.ROADMAP);
          this.innerHTML = '<i class="fas fa-satellite"></i> Show Satellite';
        } else {
          map.setMapTypeId(google.maps.MapTypeId.SATELLITE);
          this.innerHTML = '<i class="fas fa-map"></i> Show Street Map';
        }
        isSatelliteView = !isSatelliteView;
      });
  }

  // Helper function to clear all polygons
  function clearPolygons() {
    for (let i = 0; i < drawnItems.length; i++) {
      drawnItems[i].setMap(null);
    }
    drawnItems = [];
  }

  function initControls() {
    // Confirm area button
    document
      .getElementById("confirm-area-button")
      .addEventListener("click", function () {
        if (isPolygonComplete && drawnItems.length > 0) {
          const polygon = drawnItems[0];
          const path = polygon.getPath();
          const coordinates = [];

          // Extract coordinates from the polygon path
          for (let i = 0; i < path.getLength(); i++) {
            const point = path.getAt(i);
            coordinates.push({
              lat: point.lat(),
              lng: point.lng(),
            });
          }

          sendCommand(
            "save_area",
            { coordinates: coordinates },
            function (response) {
              if (response.success) {
                showAlert("Mowing area saved successfully!", "success");
                document.getElementById("confirm-home-button").disabled = false;
              } else {
                showAlert("Failed to save mowing area.", "danger");
              }
            }
          );
        }
      });

    // Set home location button
    document
      .getElementById("confirm-home-button")
      .addEventListener("click", function () {
        sendCommand("get_position", {}, function (response) {
          if (
            response.success &&
            response.data.latitude &&
            response.data.longitude
          ) {
            const homeLocation = {
              lat: response.data.latitude,
              lng: response.data.longitude,
            };

            // Add or update home marker
            if (homeMarker) {
              homeMarker.setMap(null);
            }

            // Create a custom marker for home
            homeMarker = new google.maps.Marker({
              position: homeLocation,
              map: map,
              icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 10,
                fillColor: "#4285F4",
                fillOpacity: 1,
                strokeColor: "#FFFFFF",
                strokeWeight: 2,
              },
              title: "Home Location",
            });

            // Save home location
            sendCommand(
              "save_home",
              {
                location: [homeLocation.lat, homeLocation.lng],
              },
              function (response) {
                if (response.success) {
                  showAlert("Home location saved successfully!", "success");
                } else {
                  showAlert("Failed to save home location.", "danger");
                }
              }
            );
          } else {
            showAlert(
              "Unable to get current position for home location.",
              "danger"
            );
          }
        });
      });

    // Check polygon button
    document
      .getElementById("check-polygon-button")
      .addEventListener("click", function () {
        if (drawnItems.length > 0) {
          const polygon = drawnItems[0];
          const path = polygon.getPath();
          const coordinates = [];

          // Extract coordinates from the polygon path
          for (let i = 0; i < path.getLength(); i++) {
            const point = path.getAt(i);
            coordinates.push([point.lat().toFixed(6), point.lng().toFixed(6)]);
          }

          document.getElementById("coordinates-display").textContent =
            JSON.stringify(coordinates, null, 2);
          document.getElementById("coordinatesCard").style.display = "block";
        } else {
          showAlert("No polygon defined yet.", "warning");
        }
      });

    // Close coordinates card
    document
      .getElementById("close-coordinates")
      .addEventListener("click", function () {
        document.getElementById("coordinatesCard").style.display = "none";
      });

    // Copy coordinates
    document
      .getElementById("copy-coordinates")
      .addEventListener("click", function () {
        const coordText = document.getElementById(
          "coordinates-display"
        ).textContent;
        navigator.clipboard.writeText(coordText).then(
          function () {
            showAlert("Coordinates copied to clipboard!", "success", 2000);
          },
          function () {
            showAlert("Failed to copy coordinates.", "danger");
          }
        );
      });

    // Reset area button
    document
      .getElementById("reset-area-button")
      .addEventListener("click", function () {
        clearPolygons();
        if (homeMarker) {
          homeMarker.setMap(null);
          homeMarker = null;
        }
        isPolygonComplete = false;
        document.getElementById("confirm-area-button").disabled = true;
        document.getElementById("confirm-home-button").disabled = true;
        document.getElementById("coordinatesCard").style.display = "none";
      });
  }

  function loadExistingArea() {
    sendCommand("get_area", {}, function (response) {
      if (
        response.success &&
        response.data.coordinates &&
        response.data.coordinates.length > 0
      ) {
        // Clear any existing polygons
        clearPolygons();

        // Convert coordinates to Google Maps LatLng objects
        const coordinates = response.data.coordinates;
        const path = coordinates.map((coord) => {
          return {
            lat:
              typeof coord.lat === "number" ? coord.lat : parseFloat(coord.lat),
            lng:
              typeof coord.lng === "number" ? coord.lng : parseFloat(coord.lng),
          };
        });

        // Create a polygon from the coordinates
        const polygon = new google.maps.Polygon({
          paths: path,
          strokeColor: "#689F38",
          strokeOpacity: 1.0,
          strokeWeight: 3,
          fillColor: "#8BC34A",
          fillOpacity: 0.5,
          editable: true,
        });

        // Add the polygon to the map and our array
        polygon.setMap(map);
        drawnItems.push(polygon);

        // Fit the map to the polygon
        const bounds = new google.maps.LatLngBounds();
        path.forEach((point) => bounds.extend(point));
        map.fitBounds(bounds);

        isPolygonComplete = true;
        document.getElementById("confirm-area-button").disabled = false;
        document.getElementById("confirm-home-button").disabled = false;

        showAlert("Loaded existing mowing area.", "success", 3000);
      }
    });

    // Load home location if available
    sendCommand("get_home", {}, function (response) {
      if (
        response.success &&
        response.data.location &&
        response.data.location.length === 2
      ) {
        const homeLocation = {
          lat: response.data.location[0],
          lng: response.data.location[1],
        };

        // Create a custom marker for home
        homeMarker = new google.maps.Marker({
          position: homeLocation,
          map: map,
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 10,
            fillColor: "#4285F4",
            fillOpacity: 1,
            strokeColor: "#FFFFFF",
            strokeWeight: 2,
          },
          title: "Home Location",
        });
      }
    });
  }

  // Initialize camera controls
  function initCameraControls() {
    const toggleCameraBtn = document.getElementById("toggleCameraBtn");
    const videoFeed = document.getElementById("video_feed");
    const cameraOverlay = document.getElementById("cameraOverlay");

    let cameraActive = true;

    if (toggleCameraBtn && videoFeed) {
      toggleCameraBtn.addEventListener("click", function () {
        cameraActive = !cameraActive;
        if (cameraActive) {
          videoFeed.style.opacity = "1";
          this.innerHTML = '<i class="fas fa-video"></i> Disable Camera';
        } else {
          videoFeed.style.opacity = "0.2";
          this.innerHTML = '<i class="fas fa-video-slash"></i> Enable Camera';
        }
        sendCommand("toggle_camera", { enabled: cameraActive });
      });
    }

    // Handle video feed loading
    if (videoFeed && cameraOverlay) {
      videoFeed.onload = function () {
        cameraOverlay.style.display = "none";
      };

      videoFeed.onerror = function () {
        cameraOverlay.style.display = "flex";
        cameraOverlay.innerHTML =
          '<div class="camera-status">Camera Unavailable</div>';
      };
    }
  }

  // Update the area page connection status
  function updateAreaConnectionStatus() {
    const statusIndicator = document.getElementById("areaConnectionStatus");
    const statusText = document.getElementById("areaStatusText");

    if (statusIndicator && statusText) {
      if (isConnected) {
        statusIndicator.className = "status-indicator status-online";
        statusText.textContent = "Connected";
      } else {
        statusIndicator.className = "status-indicator status-offline";
        statusText.textContent = "Disconnected";
      }
    }
  }

  // Clean up when navigating away
  window.addEventListener("beforeunload", function () {
    if (map) {
      map.remove();
    }
  });
</script>

<style>
  /* Area page specific styles */
  .map-container {
    height: 400px;
    width: 100%;
    border-radius: var(--border-radius);
    z-index: 1;
  }

  .map-controls {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    margin-top: 1.5rem;
  }

  .map-instructions {
    color: var(--gray);
    font-size: 0.9rem;
  }

  .coordinates-display {
    background-color: var(--dark);
    color: var(--light);
    padding: 1rem;
    border-radius: var(--border-radius);
    font-family: monospace;
    white-space: pre-wrap;
    overflow-x: auto;
    max-height: 200px;
  }

  .home-marker {
    color: var(--primary);
    font-size: 24px;
    text-align: center;
    line-height: 30px;
  }

  .camera-container {
    position: relative;
    width: 100%;
    height: 250px;
    background-color: var(--dirt-pale);
    border-radius: var(--border-radius);
    overflow: hidden;
  }

  .camera-feed {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .camera-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    color: white;
  }

  .camera-status {
    font-size: 1.2rem;
    text-align: center;
  }

  /* Responsive adjustments */
  @media (max-width: 992px) {
    .map-controls {
      grid-template-columns: 1fr;
    }
  }
  @media (max-width: 576px) {
    .map-container {
      height: 450px;
    }

    .camera-container {
      height: 200px;
    }
  }
</style>
{% endblock %}
